<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Stock Prediction - FinanceAI</title>
    <link rel="icon" type="image/png" href="{% static 'stock.png' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="{% url 'index' %}" class="logo">
                <div class="logo-icon logo-icon-chart">
                    <svg class="logo-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l5-5 4 4 9-9"/><path d="M21 12v6h-6"/></svg>
                </div>
                <span class="gradient-text">FinanceAI</span>
            </a>
            <div style="display: flex; align-items: center; gap: 20px;">
                <span id="user-name" style="color: var(--text-secondary); font-size: 14px;">Welcome, User</span>
                <button onclick="logout()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                    Sign Out
                </button>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    {% include 'includes/sidebar.html' with active='prediction' %}

    <!-- Main Content -->
    <main class="main-content prediction-playground">
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
                <h1 class="page-title">Stock Prediction Playground <span class="prediction-pro-badge">Pro</span></h1>
                <p class="page-subtitle">Research symbols, analyze price history, run AI-backed predictions, and backtest strategies. For educational use only.</p>
            </div>
            <button type="button" id="theme-toggle" class="btn btn-secondary" style="padding: 8px 16px;">üåô Dark</button>
        </div>

        <div class="section-label">Symbol &amp; quote</div>
        <div class="prediction-search-card">
            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                <div style="position: relative; flex: 1; min-width: 200px; max-width: 360px;">
                    <label style="color: var(--text-secondary); font-size: 12px; display: block; margin-bottom: 4px;">Search by name or ticker</label>
                    <input type="text" id="stock-search" class="form-input" placeholder="e.g. RELIANCE, TCS, Apple" autocomplete="off">
                    <div id="stock-search-dropdown" class="glass-card" style="position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; max-height: 280px; overflow-y: auto; display: none; z-index: 10;"></div>
                </div>
                <div>
                    <label style="color: var(--text-secondary); font-size: 12px; display: block; margin-bottom: 4px;">Or select</label>
                    <select id="stock-select" class="form-select" style="width: 260px;" onchange="loadStockData()">
                        <option value="">Select a stock...</option>
                    </select>
                </div>
                <div id="prediction-helper" class="prediction-helper" style="display: none; flex-basis: 100%; margin-top: 8px;">
                    <span class="prediction-helper-text">Choose a stock from the dropdown above or search by name/ticker to load the chart and make predictions.</span>
                </div>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <div class="prediction-stat">
                        <div class="prediction-stat-label">Price</div>
                        <span id="current-price" class="prediction-stat-value" style="color: var(--accent-cyan);">--</span>
                    </div>
                    <div class="prediction-stat">
                        <div class="prediction-stat-label">Change</div>
                        <span id="price-change" class="prediction-stat-value">--</span>
                    </div>
                    <div class="prediction-stat">
                        <div class="prediction-stat-label">Volume</div>
                        <span id="stock-volume" class="prediction-stat-value">--</span>
                    </div>
                    <div class="prediction-stat">
                        <div class="prediction-stat-label">Mkt Cap</div>
                        <span id="stock-mcap" class="prediction-stat-value">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="charts-grid" style="grid-template-columns: 2fr 1fr;">
            <div class="chart-card chart-card-pro">
                <div class="chart-header">
                    <h3 class="chart-title">Price History</h3>
                    <div class="chart-range-btn-group" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" class="chart-range-btn btn btn-secondary" data-range="1D">1D</button>
                        <button type="button" class="chart-range-btn btn btn-secondary" data-range="1W">1W</button>
                        <button type="button" class="chart-range-btn btn btn-primary" data-range="1M">1M</button>
                        <button type="button" class="chart-range-btn btn btn-secondary" data-range="3M">3M</button>
                        <button type="button" class="chart-range-btn btn btn-secondary" data-range="1Y">1Y</button>
                        <span style="width: 8px;"></span>
                        <button type="button" id="chart-type-line" class="btn btn-primary">Line</button>
                        <button type="button" id="chart-type-candle" class="btn btn-secondary">Candlestick</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="stockChart"></canvas>
                </div>
                <div style="display: flex; gap: 16px; margin-top: 12px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;"><input type="checkbox" id="ind-toggle-rsi"> RSI</label>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;"><input type="checkbox" id="ind-toggle-macd"> MACD</label>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;"><input type="checkbox" id="ind-toggle-ma"> MA(50/200)</label>
                    <label style="display: flex; align-items: center; gap: 6px; font-size: 13px;"><input type="checkbox" id="ind-toggle-bb"> Bollinger</label>
                </div>
                <div id="indicator-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 16px;"></div>
            </div>

            <!-- Prediction Panel -->
            <div>
                <div class="prediction-panel-pro glass-card" style="margin-bottom: 24px;">
                    <h3>Your prediction</h3>
                    <p class="panel-sub">Choose direction and AI model, then submit or forecast 7 days.</p>
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 12px; color: var(--text-muted);">Model</label>
                        <select id="ai-model-select" class="form-select" style="width: 100%;">
                            <option value="linear">Linear Regression</option>
                            <option value="lstm">LSTM</option>
                            <option value="arima">ARIMA</option>
                            <option value="rf">Random Forest</option>
                        </select>
                    </div>
                    <div class="prediction-buttons">
                        <button id="btn-up" class="prediction-btn up" onclick="selectPrediction('up')">
                            <div class="prediction-btn-icon">üìà</div>
                            <div class="prediction-btn-label">GO UP</div>
                        </button>
                        <button id="btn-down" class="prediction-btn down" onclick="selectPrediction('down')">
                            <div class="prediction-btn-icon">üìâ</div>
                            <div class="prediction-btn-label">GO DOWN</div>
                        </button>
                    </div>
                    <button id="submit-prediction" class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="submitPrediction()" disabled>Submit Prediction</button>
                    <button id="predict-7days" class="btn btn-secondary" style="width: 100%; margin-top: 8px;" onclick="predictNext7Days()">üìà Predict Next 7 Days</button>
                </div>

                <!-- AI Prediction Result -->
                <div id="ai-result" class="prediction-panel-pro glass-card" style="display: none;">
                    <h3>AI signal</h3>
                    <div class="result-display">
                        <div id="ai-prediction" class="result-value" style="color: var(--accent-red);">DOWN</div>
                        <div id="ai-trend-label" style="font-size: 13px; color: var(--text-secondary);">üìâ Bearish</div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary); font-size: 14px;">Confidence</span>
                            <span id="ai-confidence-value" style="font-weight: 600;">72%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 72%;"></div>
                        </div>
                    </div>
                </div>
                <!-- Sentiment -->
                <div class="prediction-panel-pro glass-card" style="margin-top: 24px;">
                    <h4 style="margin-bottom: 8px; font-size: 14px;">News sentiment</h4>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span id="sentiment-emoji" style="font-size: 28px;">üòê</span>
                        <span id="sentiment-label" style="font-weight: 600;">Neutral</span>
                    </div>
                    <div style="height: 120px;"><canvas id="sentiment-pie"></canvas></div>
                </div>
                <!-- Risk Meter -->
                <div class="prediction-panel-pro glass-card" style="margin-top: 24px;">
                    <h4 style="margin-bottom: 8px; font-size: 14px;">Risk meter</h4>
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px;"><span>Level</span><span id="risk-score">--</span></div>
                        <div class="risk-gauge-pro"><div id="risk-gauge" class="risk-gauge-fill" style="width: 33%; background: var(--accent-green);"></div></div>
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted);">Volatility: <span id="risk-vol">--</span>% ¬∑ Beta: <span id="risk-beta">--</span></div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">52W: <span id="risk-52w">--</span></div>
                </div>
            </div>
        </div>

        <div class="section-label">Compare &amp; backtest</div>
        <!-- Compare Two Stocks -->
        <div class="glass-card" style="padding: 24px; margin-top: 12px;">
            <h3 style="margin-bottom: 16px;">Compare two stocks</h3>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                <div><label style="font-size: 12px;">Stock A</label><select id="compare-a" class="form-select" style="width: 160px;"></select></div>
                <div><label style="font-size: 12px;">Stock B</label><select id="compare-b" class="form-select" style="width: 160px;"></select></div>
                <button type="button" class="btn btn-primary" onclick="runCompare()">Compare</button>
            </div>
            <div id="compare-result" style="margin-top: 16px; display: none;">
                <!-- Summary Stats -->
                <div id="compare-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px; font-size: 12px;"></div>
                
                <!-- Charts Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                    <!-- Price Comparison - Line Chart -->
                    <div class="glass-card" style="padding: 12px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-align: center;">Price Trend</div>
                        <div class="chart-container" style="height: 200px;"><canvas id="compareChartPrice"></canvas></div>
                    </div>
                    
                    <!-- Returns Comparison - Bar Chart -->
                    <div class="glass-card" style="padding: 12px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-align: center;">Return (%)</div>
                        <div class="chart-container" style="height: 200px;"><canvas id="compareChartReturn"></canvas></div>
                    </div>
                    
                    <!-- Volatility - Bar Chart -->
                    <div class="glass-card" style="padding: 12px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-align: center;">Volatility</div>
                        <div class="chart-container" style="height: 200px;"><canvas id="compareChartVolatility"></canvas></div>
                    </div>
                    
                    <!-- Normalized Performance - Line Chart -->
                    <div class="glass-card" style="padding: 12px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-align: center;">Normalized Performance (Base 100)</div>
                        <div class="chart-container" style="height: 200px;"><canvas id="compareChartNormalized"></canvas></div>
                    </div>
                    
                    <!-- Daily Returns - Bar Chart -->
                    <div class="glass-card" style="padding: 12px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-align: center;">Daily Returns Distribution</div>
                        <div class="chart-container" style="height: 200px;"><canvas id="compareChartDailyReturns"></canvas></div>
                    </div>
                    
                    <!-- Price Ratio - Area Chart -->
                    <div class="glass-card" style="padding: 12px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-align: center;">Price Ratio (A/B)</div>
                        <div class="chart-container" style="height: 200px;"><canvas id="compareChartRatio"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backtest -->
        <div class="glass-card" style="padding: 24px; margin-top: 24px;">
            <h3 style="margin-bottom: 16px;">Backtest strategy</h3>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                <div><label style="font-size: 12px;">Symbol</label><select id="backtest-symbol" class="form-select" style="width: 120px;"></select></div>
                <div><label style="font-size: 12px;">Strategy</label><select id="backtest-strategy" class="form-select" style="width: 160px;">
                    <option value="ma_crossover">MA Crossover</option>
                    <option value="rsi_reversal">RSI Reversal</option>
                    <option value="bollinger_bounce">Bollinger Bounce</option>
                    <option value="buy_hold">Buy & Hold</option>
                    <option value="momentum">Momentum (20d)</option>
                </select></div>
                <div><label style="font-size: 12px;">Capital (‚Çπ)</label><input type="number" id="backtest-capital" class="form-input" value="100000" style="width: 120px;" min="10000" step="10000"></div>
                <button type="button" class="btn btn-primary" onclick="runBacktest()">Run Backtest</button>
            </div>
            <div id="backtest-result" style="margin-top: 16px; display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 16px;">
                    <div class="glass-card" style="padding: 14px; text-align: center;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Total Return</div>
                        <div id="bt-return" style="font-size: 20px; font-weight: 700; color: var(--accent-cyan);">--</div>
                        <div style="font-size: 12px;">%</div>
                    </div>
                    <div class="glass-card" style="padding: 14px; text-align: center;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Max Drawdown</div>
                        <div id="bt-dd" style="font-size: 20px; font-weight: 700; color: var(--accent-orange);">--</div>
                        <div style="font-size: 12px;">%</div>
                    </div>
                    <div class="glass-card" style="padding: 14px; text-align: center;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Sharpe Ratio</div>
                        <div id="bt-sharpe" style="font-size: 20px; font-weight: 700;">--</div>
                    </div>
                    <div class="glass-card" style="padding: 14px; text-align: center;">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Final Value</div>
                        <div id="bt-final" style="font-size: 18px; font-weight: 700; color: var(--accent-green);">--</div>
                    </div>
                </div>
                <div class="chart-container" style="height: 220px; margin-bottom: 12px;"><canvas id="backtestChart"></canvas></div>
                <div class="chart-container" style="height: 160px;"><canvas id="backtestDrawdownChart"></canvas></div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="glass-card" style="padding: 24px; margin-top: 24px;">
            <h3 style="margin-bottom: 16px;">Leaderboard</h3>
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">Best prediction accuracy (min 5 resolved)</p>
            <div id="leaderboard-list" style="font-size: 14px;">Loading...</div>
        </div>

        <!-- Comparison Display -->
        <div id="comparison-section" class="glass-card" style="padding: 32px; margin-top: 24px; display: none;">
            <h3 style="margin-bottom: 24px; text-align: center;">Prediction Results</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
                <div style="text-align: center; padding: 24px; background: var(--bg-glass); border-radius: var(--radius-lg); border: 2px solid var(--accent-cyan);">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Your Prediction</div>
                    <div id="user-result" style="font-size: 32px; font-weight: 700; color: var(--accent-green);">UP</div>
                </div>
                <div style="text-align: center; padding: 24px; background: var(--bg-glass); border-radius: var(--radius-lg); border: 2px solid var(--accent-purple);">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">AI Prediction</div>
                    <div id="ai-result-display" style="font-size: 32px; font-weight: 700; color: var(--accent-red);">DOWN</div>
                </div>
                <div style="text-align: center; padding: 24px; background: var(--bg-glass); border-radius: var(--radius-lg); border: 2px solid var(--accent-blue);">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Actual Result</div>
                    <div id="actual-result" style="font-size: 32px; font-weight: 700; color: var(--accent-red);">DOWN</div>
                </div>
            </div>
            <div id="result-message" style="text-align: center; margin-top: 24px; padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); color: var(--accent-red);">
                The AI was correct! The stock went down by 2.1%
            </div>
        </div>

        <!-- AI Explanation -->
        <div id="explanation-section" class="glass-card" style="padding: 24px; margin-top: 24px; display: none;">
            <h3 style="margin-bottom: 16px;">AI Explanation</h3>
            <p id="ai-explanation" style="color: var(--text-secondary); line-height: 1.8;">
                Based on recent technical analysis, the stock shows bearish signals including a death cross pattern, 
                decreasing trading volume, and negative momentum indicators. Recent news sentiment is also slightly 
                negative due to supply chain concerns. The AI model factors in these technical indicators along with 
                historical patterns to predict a downward movement with 72% confidence.
            </p>
        </div>

        <!-- Prediction History + Scoreboard -->
        <div class="glass-card" style="padding: 24px; margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
                <h3 style="margin: 0;">Prediction history</h3>
                <div style="display: flex; gap: 16px; font-size: 13px; color: var(--text-secondary);">
                    <div>
                        <div style="font-weight: 600; color: var(--accent-cyan);">You</div>
                        <div>Total: <span id="user-total">0</span></div>
                        <div>Correct: <span id="user-correct">0</span></div>
                        <div>Accuracy: <span id="user-accuracy">0%</span></div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: var(--accent-purple);">AI Model</div>
                        <div>Accuracy (mock): <span id="ai-accuracy">--%</span></div>
                    </div>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Stock</th>
                        <th>Your Prediction</th>
                        <th>AI Prediction</th>
                        <th>Actual</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody id="prediction-history-body">
                    <!-- Filled by JS from /api/prediction/stats/ -->
                </tbody>
            </table>
        </div>

        <p class="prediction-disclaimer"><strong>Disclaimer:</strong> This playground is for education and simulation only. Predictions and backtests are not investment advice. Past performance does not guarantee future results. Always do your own research and consider consulting a financial advisor.</p>
    </main>

    <script src="{% static 'js/auth.js' %}"></script>
    <script src="{% static 'js/news-notification.js' %}"></script>
    <script src="{% static 'js/prediction.js' %}"></script>
</body>
</html>
